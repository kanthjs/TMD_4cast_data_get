WT = if_else(rain >= 0.1, 1, 0)
)
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2)
)
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)
) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2))
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)
) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT))
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)
) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
:mutate(
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)
) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
:mutate(
rowbind[1,]$data |> map_df(~.x) |> #group_by(id) |>
mutate(
RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)
) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
:mutate(
rowbind[1, ]$data |> map_df( ~ .x) |> #group_by(id) |>
mutate(RH2 = if_else(rh > 90, 1, 0), WT = if_else(rain >= 0.1, 1, 0)) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
mutate(
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
)
rowbind[1, ]$data |> map_df( ~ .x) |> #group_by(id) |>
mutate(RH2 = if_else(rh > 90, 1, 0), WT = if_else(rain >= 0.1, 1, 0)) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
mutate(
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
) |>
summarise(index = if_else(BUS4 >= 2.25, 1, 0))
rowbind[1, ]$data |> map_df( ~ .x) |> #group_by(id) |>
mutate(RH2 = if_else(rh > 90, 1, 0), WT = if_else(rain >= 0.1, 1, 0)) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
mutate(
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
) |>
summarise(index = if_else(BUS4 >= 2.25, 1, 0),
BUS_warning = if_else(BUS_index >= 1, "YES", "NO"))
rowbind[1, ]$data |> map_df( ~ .x) |> #group_by(id) |>
mutate(RH2 = if_else(rh > 90, 1, 0), WT = if_else(rain >= 0.1, 1, 0)) |>
summarise(Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)) |>
mutate(
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
) |>
summarise(index = if_else(BUS4 >= 2.25, 1, 0),
BUS_warning = if_else(index >= 1, "YES", "NO"))
install.packages("nplyr")
library(nplyr)
library(nplyr)
gapminder::gapminder_unfiltered
library(gapminder)
install.packages("gapminder")
library(gapminder)
gapminder::gapminder_unfiltered
gapminder::gapminder_unfiltered %>%
tidyr::nest(country_data = -continent)
rowbind
list_rbind(names_to = "id")
list_DF |> list_rbind(names_to = "id")
list_DF |> list_rbind(names_to = "id") |> tidyr::nest(weather_data = -tambon.code)
WeatherAtLocation <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) |>
WeatherAtLocation <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code)
WeatherAtLocation <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2)
) %>% nest_summarize(weather_data, index = if_else(BUS4 >= 2.25, 1, 0),
BUS_warning = if_else(index >= 1, "YES", "NO") )
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>%
mutate(BUS_warning = map(weather_data, function(inddex) if_else(index >= 1, "YES", "NO")))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>%
summarise(BUS_warning = map(weather_data, function(inddex) if_else(index >= 1, "YES", "NO")))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>%
summarise(BUS_warning = map(weather_data, function(index) if_else(index >= 1, "YES", "NO")))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>%
summarise(BUS_warning = map(weather_data, if_else(index >= 1, "YES", "NO")))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>% nest_summarise(weather_data, n = n())
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>% nest_summarise(weather_data, BUS_w = if_else(index >= 1, "YES", "NO"))
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>% nest_summarise(weather_data, BUS_w = if_else(index >= 1, "YES", "NO")) %>%
enframe()
gm_nest <- gapminder::gapminder %>% tidyr::nest(country_data = -continent)
# a summary applied to an ungrouped tbl returns a single row
gm_nest %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop)
)
# usually, you'll want to group first
gm_nest %>%
nest_group_by(country_data, country) %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop)
)
# usually, you'll want to group first
gm_nest %>%
nest_group_by(country_data, country) %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop) %>%
unnest(country_data)
)
# usually, you'll want to group first
gm_nest %>%
nest_group_by(country_data, country) %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop) %>%
unnest()
)
# usually, you'll want to group first
gm_nest %>%
nest_group_by(country_data, country) %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop) %>%
tidyr::unnest()
)
# usually, you'll want to group first
gm_nest %>%
nest_group_by(country_data, country) %>%
nest_summarise(
country_data,
n = n(),
median_pop = median(pop) %>%
tidyr::unnest(countruy_data)
)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>% nest_summarise(weather_data, BUS_w = if_else(index >= 1, "YES", "NO"))
test <- WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT),
BUS1 = if_else(Tbar > 14, cum_WT / 4, 0),
BUS2 = if_else(cum_RH2 >= 16, BUS1 + ((cum_RH2 - 12) / 6), BUS1),
BUS3 = if_else(Tbar < 23 &
Tbar > 26, BUS2 - 2, BUS2),
BUS4 = if_else(Tbar < 19 &
Tbar > 29, BUS3 - 2, BUS2),
index = if_else(BUS4 >= 2.25, 1, 0)
) %>% nest_summarise(weather_data, BUS_w = if_else(index >= 1, "YES", "NO"))
View(test)
View(test[[2]][[1]])
View(test[[2]][[1]])
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0),
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)
)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)) %>%
nest_summarize(weather.data,
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)
)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)) %>%
nest_summarize(weather_data,
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)
)
WeatherAtLocation %>%
nest_mutate(weather_data, RH2 = if_else(rh > 90, 1, 0),
WT = if_else(rain >= 0.1, 1, 0)) %>%
nest_summarize(weather_data,
Tbar = mean(tc),
cum_RH2 = sum(RH2),
cum_WT = sum(WT)
) %>%
unnest()
list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code)
test <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) %>%
nest_mutate(weather_data, Date = (time))
library(lubridate)
test <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) %>%
nest_mutate(weather_data, Date = dmy(time))
test <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) %>%
nest_mutate(weather_data, Date = dmy(as.Date(time))
WeatherAtLocation %>%
test <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) %>%
nest_mutate(weather_data, Date = dmy(as.Date(time)))
View(test)
View(test[[2]][[1]])
test <- list_DF |> list_rbind(names_to = "id") |>
tidyr::nest(weather_data = -tambon.code) %>%
nest_mutate(weather_data, Date = substr(time, start = 1, stop = 10)
)
View(test[[2]][[1]])
list_DF
json
weath$Date <- substr(weath$time, start = 1, stop = 10) |> ymd()
getWeather <- function(province.th, amphoe.th, tambon.th) {
base.url <- "https://data.tmd.go.th/nwpapi/v1/forecast/location/hourly/place?"
json <- request(base.url) |>
req_auth_bearer_token(Sys.getenv("tmd_token")) |>
req_url_query(
province = province.th,
amphoe = amphoe.th,
tambon = tambon.th,
fields = 'cond,tc,rh,rain',
date = "2024-10-12",
hour = 0,
duration = 23,
.multi = "explode"
) |>
req_throttle(rate = 10 / 60) |>
req_perform() |>
resp_body_json()
weath <- json |> pluck(1, 1) |> pluck("forecasts") |> map_dfr(\(x) {
tibble(
time = x |> pluck("time"),
tc = x |> pluck("data", "tc"),
rh = x |> pluck("data", "rh"),
rain = x |> pluck("data", "rain"),
cond = x |> pluck("data", "cond")
)
})
weath$tambon.code <- location_th$ADM3_PCODE[i]
weath$Date <- substr(weath$time, start = 1, stop = 10) |> ymd()
weath %>% relocate(tambon.code)
}
# retrieve
list_DF <- list()
#for (i in 60:nrow(all.marks)){
for (i in 1:10){
print(i)
list_DF[[i]] <- getWeather(province.th = location_th$ADM1_TH[i],
amphoe.th = location_th$ADM2_TH[i],
tambon.th = location_th$ADM3_TH[i])
}
saveRDS(list_DF, file = "TMD10.rds")
list_DF
getWeather <- function(province.th, amphoe.th, tambon.th) {
base.url <- "https://data.tmd.go.th/nwpapi/v1/forecast/location/hourly/place?"
json <- request(base.url) |>
req_auth_bearer_token(Sys.getenv("tmd_token")) |>
req_url_query(
province = province.th,
amphoe = amphoe.th,
tambon = tambon.th,
fields = 'cond,tc,rh,rain',
date = "2024-10-12",
hour = 0,
duration = 23,
.multi = "explode"
) |>
req_throttle(rate = 10 / 60) |>
req_perform() |>
resp_body_json()
weath <- json |> pluck(1, 1) |> pluck("forecasts") |> map_dfr(\(x) {
tibble(
time = x |> pluck("time"),
tc = x |> pluck("data", "tc"),
rh = x |> pluck("data", "rh"),
rain = x |> pluck("data", "rain"),
cond = x |> pluck("data", "cond")
)
})
weath$tambon.code <- location_th$ADM3_PCODE[i]
weath$Date <- substr(weath$time, start = 1, stop = 10) |> ymd()
weath %>% relocate(tambon.code, Date)
}
rowbind <- list_DF |> list_rbind(names_to = "id") |> nest_by(tambon.code, Date)
View(rowbind)
View(rowbind[[3]][[1]])
getWeather <- function(province.th, amphoe.th, tambon.th) {
base.url <- "https://data.tmd.go.th/nwpapi/v1/forecast/location/hourly/place?"
json <- request(base.url) |>
req_auth_bearer_token(Sys.getenv("tmd_token")) |>
req_url_query(
province = province.th,
amphoe = amphoe.th,
tambon = tambon.th,
fields = 'cond,tc,rh,rain',
date = "2024-10-12",
hour = 0,
duration = 24,
.multi = "explode"
) |>
req_throttle(rate = 10 / 60) |>
req_perform() |>
resp_body_json()
weath <- json |> pluck(1, 1) |> pluck("forecasts") |> map_dfr(\(x) {
tibble(
time = x |> pluck("time"),
tc = x |> pluck("data", "tc"),
rh = x |> pluck("data", "rh"),
rain = x |> pluck("data", "rain"),
cond = x |> pluck("data", "cond")
)
})
weath$tambon.code <- location_th$ADM3_PCODE[i]
weath$Date <- substr(weath$time, start = 1, stop = 10) |> ymd()
weath %>% relocate(tambon.code, Date)
}
